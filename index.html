<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard Achats & Ventes ‚Äî NBBC Gestion</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable (pour tables PDF bien format√©es) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {50:'#eaf2ff',100:'#d7e6ff',200:'#aaccff',300:'#7db3ff',400:'#4f99ff',500:'#1a75ff',600:'#145ed1',700:'#104aa5',800:'#0b3578',900:'#071f4b'},
            accent: {400:'#ffdf70',500:'#ffd443',600:'#f7c425'},
            ink: {700:'#1f2937',800:'#111827'},
            red: {500:'#ef4444',600:'#dc2626'},
            purple: {500:'#8b5cf6',600:'#7c3aed'}
          },
          boxShadow: {glow:'0 10px 30px rgba(26,117,255,0.20), 0 4px 14px rgba(0,0,0,0.08)',glass:'0 10px 30px rgba(16, 74, 165, 0.18), inset 0 1px 0 rgba(255,255,255,0.25)',soft:'0 12px 24px rgba(0,0,0,0.08)',neon:'0 0 20px rgba(26,117,255,0.5), 0 0 40px rgba(255,212,67,0.3)'},
          fontFamily: {sans:['Inter','Plus Jakarta Sans','system-ui','ui-sans-serif','Segoe UI','Roboto','Helvetica','Arial','sans-serif'],display:['Space Grotesk','Inter','sans-serif']}
        }
      }
    };
  </script>

  <style>
    :root { --card-bg: #ffffff; --muted: #94a3b8; }
    body { background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%); }
    .card { background: var(--card-bg); border-radius: 14px; box-shadow: var(--shadow, 0 6px 18px rgba(16,74,165,0.06)); }
    .nav-active { background: linear-gradient(90deg, rgba(26,117,255,0.08), rgba(255,212,67,0.08)); border-color: rgba(26,117,255,0.08); }
    .glow-ring { box-shadow: 0 6px 18px rgba(26,117,255,0.06); }
    .row-odd { background: rgba(250,250,250,0.8); }
    .row-even { background: transparent; }

    /* Make KPI area wider on large screens */
    @media (min-width: 1024px) {
      #dashboardWide { width: calc(100vw - 340px); margin-left: 20px; max-width: none; }
    }
    @media (max-width: 1023px) {
      #dashboardWide { width: auto; max-width: 100%; margin-left: 0; padding-left: 0; }
    }

    @media (max-width: 640px) {
      .chart-label { font-size: 10px; }
      header .card { padding: 0.25rem; }
      #modalOverlay .card { margin: 1rem; }
    }
  </style>
</head>
<body class="font-sans text-ink-800 antialiased">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-[300px] shrink-0 fixed sm:static inset-y-0 -left-[320px] sm:left-0 transition-all duration-300 z-40 bg-transparent">
      <div class="h-full flex flex-col">
        <div class="px-6 pt-6">
          <div class="card" style="--shadow: 0 10px 30px rgba(26,117,255,0.12), 0 4px 14px rgba(0,0,0,0.06)">
            <div class="p-5 flex items-center gap-3">
              <img src="nbbcl.png" alt="logo" style="width: 70px; height: auto;">
              <div>
                <div class="font-display text-xl font-bold tracking-tight text-primary-800">NBBC Gestion</div>
                <div class="text-xs text-ink-700/60">New Boss Business Center</div>
              </div>
            </div>
          </div>
        </div>

        <nav class="p-4 flex-1 overflow-y-auto">
          <ul class="space-y-2">
            <li><button data-target="dashboard" class="nav-link glow-ring w-full flex items-center gap-3 px-4 py-3 rounded-xl text-ink-700 hover:text-primary-700 transition border border-transparent">
                <span class="h-9 w-9 rounded-lg bg-primary-500/10 text-primary-600 flex items-center justify-center shadow-glow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 13h8V3H3v10Zm10 8h8V3h-8v18ZM3 21h8v-6H3v6Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg></span>
                <span class="font-semibold">Dashboard Central</span>
              </button></li>

            <li><button data-target="achats" class="nav-link glow-ring w-full flex items-center gap-3 px-4 py-3 rounded-xl text-ink-700 hover:text-primary-700 transition border border-transparent">
                <span class="h-9 w-9 rounded-lg bg-accent-500/15 text-ink-800 flex items-center justify-center shadow-glow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h12l-1 12H7L6 6Zm2 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span class="font-semibold">Gestion Achats</span>
              </button></li>

            <li><button data-target="ventes" class="nav-link glow-ring w-full flex items-center gap-3 px-4 py-3 rounded-xl text-ink-700 hover:text-primary-700 transition border border-transparent">
                <span class="h-9 w-9 rounded-lg bg-primary-500/12 text-primary-600 flex items-center justify-center shadow-glow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 15l4 4 12-12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span class="font-semibold">Gestion Ventes</span>
              </button></li>

            <li><button data-target="depenses" class="nav-link glow-ring w-full flex items-center gap-3 px-4 py-3 rounded-xl text-ink-700 hover:text-primary-700 transition border border-transparent">
                <span class="h-9 w-9 rounded-lg bg-red-500/10 text-red-600 flex items-center justify-center shadow-glow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14m-7-7l7 7 7-7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span class="font-semibold">Gestion D√©penses</span>
              </button></li>

            <li><button data-target="dettes" class="nav-link glow-ring w-full flex items-center gap-3 px-4 py-3 rounded-xl text-ink-700 hover:text-primary-700 transition border border-transparent">
                <span class="h-9 w-9 rounded-lg bg-purple-500/10 text-purple-600 flex items-center justify-center shadow-glow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span class="font-semibold">Gestion Dettes</span>
              </button></li>

            <li><button data-target="depots" class="nav-link glow-ring w-full flex items-center gap-3 px-4 py-3 rounded-xl text-ink-700 hover:text-primary-700 transition border border-transparent">
                <span class="h-9 w-9 rounded-lg bg-yellow-100 text-amber-600 flex items-center justify-center shadow-glow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 6H8v4h8V6z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                <span class="font-semibold">Gestion d√©p√¥t/retrait (flooz/mux)</span>
              </button></li>
          </ul>

          <div class="mt-8 pt-6">
            <div class="grid grid-cols-2 gap-3">
              <button id="quickAddAchat" class="glow-ring active rounded-xl px-3 py-2.5 bg-white text-primary-700 border border-primary-200 font-semibold shadow-neon hover:shadow-soft transition animation-pulseGlow text-xs sm:text-sm">+ Nouvel Achat</button>
              <button id="quickAddVente" class="glow-ring rounded-xl px-3 py-2.5 bg-gradient-to-br from-accent-500 to-yellow-300 text-ink-800 font-extrabold shadow-neon hover:brightness-105 transition animation-pulseGlow text-xs sm:text-sm">+ Nouvelle Vente</button>
              <button id="quickAddDepense" class="glow-ring active rounded-xl px-3 py-2.5 bg-white text-red-700 border border-red-200 font-semibold shadow-neon hover:shadow-soft transition animation-pulseGlow text-xs sm:text-sm">+ Nouvelle D√©pense</button>
              <button id="quickAddDette" class="glow-ring rounded-xl px-3 py-2.5 bg-gradient-to-br from-purple-500 to-purple-300 text-ink-800 font-extrabold shadow-neon hover:brightness-105 transition animation-pulseGlow text-xs sm:text-sm">+ Nouvelle Dette</button>
              <button id="quickAddDepot" class="glow-ring rounded-xl px-3 py-2.5 bg-gradient-to-br from-amber-400 to-yellow-200 text-ink-800 font-extrabold shadow-neon hover:brightness-105 transition animation-pulseGlow text-xs sm:text-sm">+ Nouveau d√©p√¥t/retrait (flooz/mux)</button>
            </div>
          </div>
        </nav>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 min-h-screen ml-[300px]">
      <header class="px-4 py-4">
        <div class="max-w-full mx-auto flex items-center justify-between">
          <div class="flex items-center gap-4">
            <button id="openSidebar" class="sm:hidden p-2 rounded-lg bg-white border border-primary-100">‚ò∞</button>
            <div>
              <div id="pageTitle" class="font-semibold text-lg">Dashboard Central</div>
              <div class="text-xs text-ink-700/60">Vue d'ensemble</div>
            </div>
          </div>

          <div class="hidden sm:flex items-center gap-3">
            <!-- optional header controls on wide screens -->
          </div>
        </div>
      </header>

      <section id="dashboardWide" class="mx-4 sm:mx-6 py-8 space-y-10" style="max-width: none;">
        <!-- DASHBOARD -->
        <div id="dashboardSection" class="section">
          <div class="grid lg:grid-cols-4 sm:grid-cols-2 grid-cols-1 gap-5">
            <div class="card animation-pulseGlow">
              <div class="p-5">
                <div class="flex items-center justify-between">
                  <div class="text-ink-700/70 text-sm">Chiffre d‚Äôaffaires</div>
                  <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-primary-500/10 text-primary-600 shadow-glow">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 14l4 4 12-12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </span>
                </div>
                <div class="mt-3 font-display text-2xl font-bold text-ink-800" id="kpiCA">‚Äî</div>
                <div class="mt-2 text-xs text-ink-700/60" id="kpiCAInfo">Bas√© sur ventes - achats | Taux de croissance: ‚Äî</div>
              </div>
            </div>

            <div class="card animation-pulseGlow">
              <div class="p-5">
                <div class="flex items-center justify-between">
                  <div class="text-ink-700/70 text-sm">Total Achats</div>
                  <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-accent-500/15 text-ink-800 shadow-glow">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h12l-1 12H7L6 6Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/></svg>
                  </span>
                </div>
                <div class="mt-3 font-display text-2xl font-bold text-ink-800" id="kpiAchats">‚Äî</div>
                <div class="mt-2 text-xs text-ink-700/60">Co√ªts cumul√©s | Moyenne par achat: ‚Äî</div>
              </div>
            </div>

            <div class="card animation-pulseGlow">
              <div class="p-5">
                <div class="flex items-center justify-between">
                  <div class="text-ink-700/70 text-sm">B√©n√©fice estim√©</div>
                  <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-accent-500/15 text-ink-800 shadow-glow">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14l3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </span>
                </div>
                <div class="mt-3 font-display text-2xl font-bold text-ink-800" id="kpiBenefice">‚Äî</div>
                <div class="mt-2 text-xs text-ink-700/60" id="kpiBeneficeInfo">‚Äî</div>
              </div>
            </div>

            <div class="card animation-pulseGlow">
              <div class="p-5">
                <div class="flex items-center justify-between">
                  <div class="text-ink-700/70 text-sm">Total D√©penses</div>
                  <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-red-500/10 text-red-600 shadow-glow">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h12l-1 12H7L6 6Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/></svg>
                  </span>
                </div>
                <div class="mt-3 font-display text-2xl font-bold text-ink-800" id="kpiDepenses">‚Äî</div>
                <div class="mt-2 text-xs text-ink-700/60">D√©penses cumul√©es | Moyenne par d√©pense: ‚Äî</div>
              </div>
            </div>
          </div>

          <div class="card mt-6">
            <div class="p-5">
              <h3 class="font-semibold text-ink-800 mb-4">√âvolution Mensuelle (Achats, D√©penses vs Ventes, Dettes)</h3>
              <svg id="monthlyChart" width="100%" height="300" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet"></svg>
              <div class="mt-4 text-xs text-ink-700/60">Donn√©es bas√©es sur les enregistrements. Bleu: Achats, Rouge: D√©penses, Jaune: Ventes, Violet: Dettes.</div>
            </div>
          </div>
        </div>

        <!-- ACHATS SECTION -->
        <div id="achatsSection" class="section hidden">
          <div class="card">
            <div class="p-5 flex flex-col md:flex-row md:items-center gap-3 md:gap-4 md:justify-between">
              <div class="flex items-center gap-3">
                <div class="text-lg font-semibold text-ink-800">Achats Enregistr√©s</div>
                <span class="text-xs text-ink-700/60 hidden sm:inline" id="achatCount">‚Äî</span>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <div class="flex items-center gap-2 bg-white border border-primary-100 rounded-xl px-3 py-2 glow-ring">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-ink-700/60"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                  <input id="searchAchats" type="text" placeholder="Rechercher un achat (article, fournisseur, date)." class="outline-none text-sm placeholder-ink-700/50 w-48 md:w-64">
                </div>
                <button id="addAchat" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-primary-600 to-primary-500 text-white font-semibold px-4 py-2.5 shadow-neon hover:brightness-105 transition glow-ring">Ajouter Achat</button>
                <button id="deleteSelectedAchats" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 font-semibold px-4 py-2.5 hover:bg-primary-50/50 transition disabled:opacity-50 glow-ring" disabled>Supprimer S√©lectionn√©s</button>
                <button id="exportAchats" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 px-4 py-2.5 hover:bg-primary-50/50 transition glow-ring">Exporter PDF Achats</button>
              </div>
            </div>

            <div class="p-5 overflow-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="text-left text-xs text-ink-700/60">
                    <th class="px-4 py-3"><input id="selectAllAchats" type="checkbox"></th>
                    <th class="px-4 py-3" data-sort="date">Date</th>
                    <th class="px-4 py-3" data-sort="item">Article</th>
                    <th class="px-4 py-3" data-sort="qty">Quantit√©</th>
                    <th class="px-4 py-3" data-sort="price">Prix Unitaire (FCFA)</th>
                    <th class="px-4 py-3" data-sort="party">Fournisseur</th>
                    <th class="px-4 py-3 text-right" data-sort="total">Total (FCFA)</th>
                    <th class="px-4 py-3 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="achatBody" class="divide-y divide-primary-50 bg-white"></tbody>
                <tfoot>
                  <tr class="bg-primary-50">
                    <td colspan="6" class="px-4 py-3 text-right font-semibold">Total Achats</td>
                    <td class="px-4 py-3 text-right font-bold" id="totalAchats">‚Äî</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- VENTES, DEPENSES, DETTES, DEPOTS similar (kept unchanged) -->
        <!-- VENTES -->
        <div id="ventesSection" class="section hidden">
          <div class="card">
            <div class="p-5 flex flex-col md:flex-row md:items-center gap-3 md:gap-4 md:justify-between">
              <div class="flex items-center gap-3"><div class="text-lg font-semibold text-ink-800">Ventes Enregistr√©es</div><span class="text-xs text-ink-700/60 hidden sm:inline" id="venteCount">‚Äî</span></div>
              <div class="flex flex-wrap items-center gap-2">
                <div class="flex items-center gap-2 bg-white border border-primary-100 rounded-xl px-3 py-2 glow-ring">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-ink-700/60"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                  <input id="searchVentes" type="text" placeholder="Rechercher une vente (article, client, date)." class="outline-none text-sm placeholder-ink-700/50 w-48 md:w-64">
                </div>
                <button id="addVente" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-accent-500 to-yellow-300 text-ink-800 font-extrabold px-4 py-2.5 shadow-neon hover:brightness-105 transition glow-ring">Ajouter Vente</button>
                <button id="deleteSelectedVentes" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 font-semibold px-4 py-2.5 hover:bg-primary-50/50 transition disabled:opacity-50 glow-ring" disabled>Supprimer S√©lectionn√©s</button>
                <button id="exportVentes" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 px-4 py-2.5 hover:bg-primary-50/50 transition glow-ring">Exporter PDF Ventes</button>
              </div>
            </div>
            <div class="p-5 overflow-auto">
              <table class="w-full border-collapse">
                <thead><tr class="text-left text-xs text-ink-700/60">
                  <th class="px-4 py-3"><input id="selectAllVentes" type="checkbox"></th>
                  <th class="px-4 py-3" data-sort="date">Date</th>
                  <th class="px-4 py-3" data-sort="item">Article</th>
                  <th class="px-4 py-3" data-sort="qty">Quantit√©</th>
                  <th class="px-4 py-3" data-sort="price">Prix Unitaire (FCFA)</th>
                  <th class="px-4 py-3" data-sort="party">Client</th>
                  <th class="px-4 py-3 text-right" data-sort="total">Total (FCFA)</th>
                  <th class="px-4 py-3 text-right">Actions</th>
                </tr></thead>
                <tbody id="venteBody" class="divide-y divide-primary-50 bg-white"></tbody>
                <tfoot><tr class="bg-primary-50">
                  <td colspan="6" class="px-4 py-3 text-right font-semibold">Total Ventes</td>
                  <td class="px-4 py-3 text-right font-bold" id="totalVentes">‚Äî</td><td></td>
                </tr></tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- DEPENSES -->
        <div id="depensesSection" class="section hidden">
          <div class="card">
            <div class="p-5 flex flex-col md:flex-row md:items-center gap-3 md:gap-4 md:justify-between">
              <div class="flex items-center gap-3"><div class="text-lg font-semibold text-ink-800">D√©penses Enregistr√©es</div><span class="text-xs text-ink-700/60 hidden sm:inline" id="depenseCount">‚Äî</span></div>
              <div class="flex flex-wrap items-centered gap-2">
                <div class="flex items-center gap-2 bg-white border border-primary-100 rounded-xl px-3 py-2 glow-ring">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-ink-700/60"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                  <input id="searchDepenses" type="text" placeholder="Rechercher une d√©pense (description, b√©n√©ficiaire, date)." class="outline-none text-sm placeholder-ink-700/50 w-48 md:w-64">
                </div>
                <button id="addDepense" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-red-600 to-red-500 text-white font-semibold px-4 py-2.5 shadow-neon hover:brightness-105 transition glow-ring">Ajouter D√©pense</button>
                <button id="deleteSelectedDepenses" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 font-semibold px-4 py-2.5 hover:bg-primary-50/50 transition disabled:opacity-50 glow-ring" disabled>Supprimer S√©lectionn√©s</button>
                <button id="exportDepenses" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 px-4 py-2.5 hover:bg-primary-50/50 transition glow-ring">Exporter PDF D√©penses</button>
              </div>
            </div>
            <div class="p-5 overflow-auto">
              <table class="w-full border-collapse">
                <thead><tr class="text-left text-xs text-ink-700/60">
                  <th class="px-4 py-3"><input id="selectAllDepenses" type="checkbox"></th>
                  <th class="px-4 py-3" data-sort="date">Date</th>
                  <th class="px-4 py-3" data-sort="item">Description</th>
                  <th class="px-4 py-3" data-sort="qty">Quantit√©</th>
                  <th class="px-4 py-3" data-sort="price">Prix Unitaire (FCFA)</th>
                  <th class="px-4 py-3" data-sort="party">B√©n√©ficiaire</th>
                  <th class="px-4 py-3 text-right" data-sort="total">Total (FCFA)</th>
                  <th class="px-4 py-3 text-right">Actions</th>
                </tr></thead>
                <tbody id="depenseBody" class="divide-y divide-primary-50 bg-white"></tbody>
                <tfoot><tr class="bg-primary-50">
                  <td colspan="6" class="px-4 py-3 text-right font-semibold">Total D√©penses</td>
                  <td class="px-4 py-3 text-right font-bold" id="totalDepenses">‚Äî</td><td></td>
                </tr></tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- DETTES -->
        <div id="dettesSection" class="section hidden">
          <div class="card">
            <div class="p-5 flex flex-col md:flex-row md:items-center gap-3 md:gap-4 md:justify-between">
              <div class="flex items-center gap-3"><div class="text-lg font-semibold text-ink-800">Dettes Enregistr√©es</div><span class="text-xs text-ink-700/60 hidden sm:inline" id="detteCount">‚Äî</span></div>
              <div class="flex flex-wrap items-centered gap-2">
                <div class="flex items-center gap-2 bg-white border border-primary-100 rounded-xl px-3 py-2 glow-ring">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-ink-700/60"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                  <input id="searchDettes" type="text" placeholder="Rechercher une dette (description, cr√©ancier, date)." class="outline-none text-sm placeholder-ink-700/50 w-48 md:w-64">
                </div>
                <button id="addDette" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-purple-600 to-purple-500 text-white font-semibold px-4 py-2.5 shadow-neon hover:brightness-105 transition glow-ring">Ajouter Dette</button>
                <button id="deleteSelectedDettes" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 font-semibold px-4 py-2.5 hover:bg-primary-50/50 transition disabled:opacity-50 glow-ring" disabled>Supprimer S√©lectionn√©s</button>
                <button id="exportDettes" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 px-4 py-2.5 hover:bg-primary-50/50 transition glow-ring">Exporter PDF Dettes</button>
              </div>
            </div>
            <div class="p-5 overflow-auto">
              <table class="w-full border-collapse">
                <thead><tr class="text-left text-xs text-ink-700/60">
                  <th class="px-4 py-3"><input id="selectAllDettes" type="checkbox"></th>
                  <th class="px-4 py-3" data-sort="date">Date</th>
                  <th class="px-4 py-3" data-sort="item">Description</th>
                  <th class="px-4 py-3" data-sort="qty">Quantit√©</th>
                  <th class="px-4 py-3" data-sort="price">Prix Unitaire (FCFA)</th>
                  <th class="px-4 py-3" data-sort="party">Cr√©ancier</th>
                  <th class="px-4 py-3 text-right" data-sort="total">Total (FCFA)</th>
                  <th class="px-4 py-3 text-right">Actions</th>
                </tr></thead>
                <tbody id="detteBody" class="divide-y divide-primary-50 bg-white"></tbody>
                <tfoot><tr class="bg-primary-50">
                  <td colspan="6" class="px-4 py-3 text-right font-semibold">Total Dettes</td>
                  <td class="px-4 py-3 text-right font-bold" id="totalDettes">‚Äî</td><td></td>
                </tr></tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- DEPOTS -->
        <div id="depotsSection" class="section hidden">
          <div class="card">
            <div class="p-5 flex flex-col md:flex-row md:items-center gap-3 md:gap-4 md:justify-between">
              <div class="flex items-center gap-3"><div class="text-lg font-semibold text-ink-800">D√©p√¥ts / Retraits (flooz/mux)</div><span class="text-xs text-ink-700/60 hidden sm:inline" id="depotCount">‚Äî</span></div>
              <div class="flex flex-wrap items-centered gap-2">
                <div class="flex items-center gap-2 bg-white border border-primary-100 rounded-xl px-3 py-2 glow-ring">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-ink-700/60"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                  <input id="searchDepots" type="text" placeholder="Rechercher d√©p√¥t/retrait (type, op√©rateur, date, m√©thode)." class="outline-none text-sm placeholder-ink-700/50 w-48 md:w-64">
                </div>
                <button id="addDepot" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-amber-300 text-ink-800 font-extrabold px-4 py-2.5 shadow-neon hover:brightness-105 transition glow-ring">Ajouter D√©p√¥t/Retrait</button>
                <button id="deleteSelectedDepots" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 font-semibold px-4 py-2.5 hover:bg-primary-50/50 transition disabled:opacity-50 glow-ring" disabled>Supprimer S√©lectionn√©s</button>
                <button id="exportDepots" class="inline-flex items-center gap-2 rounded-xl bg-white text-ink-800 border border-primary-100 px-4 py-2.5 hover:bg-primary-50/50 transition glow-ring">Exporter PDF D√©p√¥ts</button>
              </div>
            </div>
            <div class="p-5 overflow-auto">
              <table class="w-full border-collapse">
                <thead><tr class="text-left text-xs text-ink-700/60">
                  <th class="px-4 py-3"><input id="selectAllDepots" type="checkbox"></th>
                  <th class="px-4 py-3" data-sort="date">Date</th>
                  <th class="px-4 py-3" data-sort="item">Type (D√©p√¥t/Retrait)</th>
                  <th class="px-4 py-3" data-sort="qty">Quantit√©</th>
                  <th class="px-4 py-3" data-sort="price">Montant (FCFA)</th>
                  <th class="px-4 py-3" data-sort="method">M√©thode</th>
                  <th class="px-4 py-3" data-sort="party">Op√©rateur / Compte</th>
                  <th class="px-4 py-3 text-right" data-sort="total">Total (FCFA)</th>
                  <th class="px-4 py-3 text-right">Actions</th>
                </tr></thead>
                <tbody id="depotBody" class="divide-y divide-primary-50 bg-white"></tbody>
                <tfoot><tr class="bg-primary-50">
                  <td colspan="7" class="px-4 py-3 text-right font-semibold">Total D√©p√¥ts/Retraits</td>
                  <td class="px-4 py-3 text-right font-bold" id="totalDepots">‚Äî</td><td></td>
                </tr></tfoot>
              </table>
            </div>
          </div>
        </div>

      </section>
    </main>

    <!-- Modal (formulaire unique pour tous les types) -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-ink-800/50"></div>
      <div class="relative max-w-lg mx-auto mt-16 sm:mt-24">
        <div class="card">
          <div class="px-6 py-4 flex items-center justify-between border-b border-primary-100">
            <h3 id="modalTitle" class="font-semibold text-ink-800">Nouvel enregistrement</h3>
            <button id="closeModal" class="h-9 w-9 rounded-lg bg-white border border-primary-100 text-ink-800 hover:bg-primary-50/50">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="inline"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
            </button>
          </div>

          <form id="entryForm" class="p-6 space-y-4">
            <input type="hidden" id="f_id">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-ink-700/70">Date</label>
                <input required type="date" id="f_date" class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white">
              </div>
              <div>
                <label id="f_item_label" class="text-sm text-ink-700/70">Article</label>
                <input required type="text" id="f_item" placeholder="Nom de l‚Äôarticle (ex: Ordinateur Portable)" class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white">
              </div>
              <div>
                <label class="text-sm text-ink-700/70">Quantit√©</label>
                <input required min="1" type="number" id="f_qty" placeholder="1 ou plus" class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white">
              </div>
              <div>
                <label class="text-sm text-ink-700/70" id="f_price_label">Prix Unitaire (FCFA)</label>
                <input required type="number" id="f_price" placeholder="0" class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white">
              </div>

              <div>
                <label class="text-sm text-ink-700/70">M√©thode</label>
                <select id="f_method" class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white">
                  <option value="flooz">Flooz</option>
                  <option value="mux">Mux</option>
                  <option value="tmoney">Tmoney</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <div>
                <label id="f_party_label" class="text-sm text-ink-700/70">Fournisseur / Client</label>
                <input required type="text" id="f_party" placeholder="Nom du fournisseur, client, compte, op√©rateur..." class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white">
              </div>
            </div>

            <div>
              <label class="text-sm text-ink-700/70">Note (optionnel)</label>
              <textarea id="f_note" rows="3" placeholder="Remarques..." class="mt-1 w-full rounded-xl border border-primary-100 px-3 py-2 outline-none focus:ring-2 focus:ring-primary-200 bg-white"></textarea>
            </div>

            <div id="formError" class="text-red-600 text-sm hidden">Veuillez remplir correctement les champs requis.</div>

            <div class="flex items-center justify-end gap-3 pt-2">
              <button type="button" id="cancelForm" class="px-4 py-2 rounded-xl border border-primary-100 text-ink-800 hover:bg-primary-50/50">Annuler</button>
              <button type="submit" id="saveForm" class="px-4 py-2 rounded-xl bg-primary-600 text-white font-semibold hover:brightness-105">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Confirm modal -->
    <div id="confirmOverlay" class="fixed inset-0 z-60 hidden">
      <div class="absolute inset-0 bg-ink-800/50"></div>
      <div class="relative max-w-lg mx-auto mt-28">
        <div class="card">
          <div class="px-6 py-4 flex items-center justify-between border-b border-primary-100">
            <h3 class="font-semibold text-ink-800">Confirmer l'Action</h3>
          </div>
          <div class="px-6 py-4 text-ink-800" id="confirmText">
            Voulez-vous vraiment supprimer les √©l√©ments s√©lectionn√©s ? Cette action est irr√©versible et affectera vos KPIs.
          </div>
          <div class="px-6 py-4 flex items-center justify-end gap-3">
            <button id="confirmCancel" class="px-4 py-2 rounded-xl border border-primary-100 text-ink-800 hover:bg-primary-50/50">Annuler</button>
            <button id="confirmOk" class="px-4 py-2 rounded-xl bg-red-500 text-white font-semibold hover:brightness-105">Confirmer</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ---------------------------
    // State
    // ---------------------------
    let activeSection = 'dashboard';
    let formContext = 'achat';
    let editId = null;
    let records = []; // array of { id, record_type, date, item, qty, price, party, note, method }

    const STORAGE_KEY = 'nbbc_records_v1';

    // ---------------------------
    // Helpers
    // ---------------------------
    const el = (sel) => document.querySelector(sel);
    const els = (sel) => Array.from(document.querySelectorAll(sel));
    const money = (n) => Number(n || 0).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' FCFA';

    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }

    function safeSet(selector, value) {
      const node = el(selector);
      if (node) node.textContent = value;
    }

    function safeOn(selector, event, handler) {
      const node = el(selector);
      if (node) node.addEventListener(event, handler);
    }

    // ---------------------------
    // Local Storage: load / save
    // ---------------------------
    function loadFromLocal() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          records = [];
          return;
        }
        records = JSON.parse(raw) || [];
        records = records.map(r => ({ ...r, id: Number(r.id) }));
      } catch (err) {
        console.error('Failed to load from localStorage:', err);
        records = [];
      }
    }

    function saveToLocal() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
      } catch (err) {
        console.error('Failed to save to localStorage:', err);
      }
    }

    // ---------------------------
    // Utility
    // ---------------------------
    function subtotal(r) {
      return (Number(r.qty) || 1) * (Number(r.price) || 0);
    }

    // ---------------------------
    // Rendering (KPIs, recents, tables, chart)
    // ---------------------------
    function renderKPIs() {
      // Ignore 'depot' for KPI / profit calculations as requested
      const achats = records.filter(r => r.record_type === 'achat');
      const ventes = records.filter(r => r.record_type === 'vente');
      const depenses = records.filter(r => r.record_type === 'depense');
      const dettes = records.filter(r => r.record_type === 'dette');

      const totalAchats = achats.reduce((s, r) => s + subtotal(r), 0);
      const totalVentes = ventes.reduce((s, r) => s + subtotal(r), 0);
      const totalDepenses = depenses.reduce((s, r) => s + subtotal(r), 0);
      const totalDettes = dettes.reduce((s, r) => s + subtotal(r), 0);

      const totalQtyAchats = achats.reduce((s, r) => s + (Number(r.qty) || 0), 0);
      const totalQtyVentes = ventes.reduce((s, r) => s + (Number(r.qty) || 0), 0);

      const avgUnitAchat = totalQtyAchats > 0 ? (totalAchats / totalQtyAchats) : 0;
      const avgUnitVente = totalQtyVentes > 0 ? (totalVentes / totalQtyVentes) : 0;

      const benef = (avgUnitVente - avgUnitAchat) * totalQtyVentes;

      safeSet('#kpiAchats', money(totalAchats));
      safeSet('#kpiCA', money(totalVentes));
      safeSet('#kpiCAInfo', `Bas√© sur ${ventes.length} vente(s) | Croissance: ‚Äî`);
      safeSet('#kpiBenefice', money(benef));
      safeSet('#kpiBeneficeInfo', `(${money(avgUnitVente)} - ${money(avgUnitAchat)}) √ó ${totalQtyVentes} = ${money(benef)}`);
      safeSet('#kpiDepenses', money(totalDepenses));
      safeSet('#kpiDettes', money(totalDettes));
    }

    function rowHTML(r, type, i) {
      const zebra = i % 2 ? 'row-odd' : 'row-even';
      const safeNote = (r.note || '').replace(/"/g, '&quot;');
      const noteIcon = r.note ? `<span class="ml-2 text-primary-600 cursor-help" title="${safeNote}">üìù</span>` : '';
      return `
        <tr class="${zebra} hover:shadow-neon transition">
          <td class="px-4 py-3" data-label="S√©lection">
            <input type="checkbox" data-id="${r.id}" class="rowCheck h-4 w-4 rounded border-primary-200">
          </td>
          <td class="px-4 py-3 whitespace-nowrap" data-label="Date">${r.date}</td>
          <td class="px-4 py-3" data-label="Article">${r.item} ${noteIcon}</td>
          <td class="px-4 py-3" data-label="Quantit√©">${r.qty}</td>
          <td class="px-4 py-3" data-label="Prix Unitaire">${money(r.price)}</td>
          ${ type === 'depot' ? `<td class="px-4 py-3" data-label="M√©thode">${(r.method || '')}</td>` : '' }
          <td class="px-4 py-3" data-label="Fournisseur/Client/Compte">${r.party}</td>
          <td class="px-4 py-3 text-right font-semibold" data-label="Total">${money(subtotal(r))}</td>
          <td class="px-4 py-3 text-right" data-label="Actions">
            <button data-id="${r.id}" data-type="${type}" class="editOne inline-flex items-center gap-1.5 text-primary-600 hover:brightness-110 font-medium">
              √âditer
            </button>
            <button data-id="${r.id}" data-type="${type}" class="deleteOne inline-flex items-center gap-1.5 text-red-600 hover:brightness-110 font-medium ml-4">
              Supprimer
            </button>
          </td>
        </tr>
      `;
    }

    function renderTable(type) {
      if (type === 'achat') return renderTableAchats();
      if (type === 'vente') return renderTableVentes();
      if (type === 'depense') return renderTableDepenses();
      if (type === 'dette') return renderTableDettes();
      if (type === 'depot') return renderTableDepots();
    }

    function renderTableAchats() {
      const body = el('#achatBody');
      if (!body) return;
      const q = (el('#searchAchats')?.value || '').trim().toLowerCase();
      const filtered = records.filter(r => r.record_type === 'achat' &&
        [r.item, r.party, r.date, r.note].some(v => String(v || '').toLowerCase().includes(q))
      );
      body.innerHTML = filtered.map((r, i) => rowHTML(r, 'achat', i)).join('');
      safeSet('#achatCount', `${filtered.length} √©l√©ment(s) | Filtre appliqu√© si recherche active`);
      safeSet('#totalAchats', money(filtered.reduce((s, r) => s + subtotal(r), 0)));
      updateBulkButtonsStateForTable('achat');
    }

    function renderTableVentes() {
      const body = el('#venteBody');
      if (!body) return;
      const q = (el('#searchVentes')?.value || '').trim().toLowerCase();
      const filtered = records.filter(r => r.record_type === 'vente' &&
        [r.item, r.party, r.date, r.note].some(v => String(v || '').toLowerCase().includes(q))
      );
      body.innerHTML = filtered.map((r, i) => rowHTML(r, 'vente', i)).join('');
      safeSet('#venteCount', `${filtered.length} √©l√©ment(s) | Filtre appliqu√© si recherche active`);
      safeSet('#totalVentes', money(filtered.reduce((s, r) => s + subtotal(r), 0)));
      updateBulkButtonsStateForTable('vente');
    }

    function renderTableDepenses() {
      const body = el('#depenseBody');
      if (!body) return;
      const q = (el('#searchDepenses')?.value || '').trim().toLowerCase();
      const filtered = records.filter(r => r.record_type === 'depense' &&
        [r.item, r.party, r.date, r.note].some(v => String(v || '').toLowerCase().includes(q))
      );
      body.innerHTML = filtered.map((r, i) => rowHTML(r, 'depense', i)).join('');
      safeSet('#depenseCount', `${filtered.length} √©l√©ment(s) | Filtre appliqu√© si recherche active`);
      safeSet('#totalDepenses', money(filtered.reduce((s, r) => s + subtotal(r), 0)));
      updateBulkButtonsStateForTable('depense');
    }

    function renderTableDettes() {
      const body = el('#detteBody');
      if (!body) return;
      const q = (el('#searchDettes')?.value || '').trim().toLowerCase();
      const filtered = records.filter(r => r.record_type === 'dette' &&
        [r.item, r.party, r.date, r.note].some(v => String(v || '').toLowerCase().includes(q))
      );
      body.innerHTML = filtered.map((r, i) => rowHTML(r, 'dette', i)).join('');
      safeSet('#detteCount', `${filtered.length} √©l√©ment(s) | Filtre appliqu√© si recherche active`);
      safeSet('#totalDettes', money(filtered.reduce((s, r) => s + subtotal(r), 0)));
      updateBulkButtonsStateForTable('dette');
    }

    function renderTableDepots() {
      const body = el('#depotBody');
      if (!body) return;
      const q = (el('#searchDepots')?.value || '').trim().toLowerCase();
      const filtered = records.filter(r => r.record_type === 'depot' &&
        [r.item, r.party, r.date, r.note, r.method].some(v => String(v || '').toLowerCase().includes(q))
      );
      body.innerHTML = filtered.map((r, i) => rowHTML(r, 'depot', i)).join('');
      safeSet('#depotCount', `${filtered.length} √©l√©ment(s) | Filtre appliqu√© si recherche active`);
      safeSet('#totalDepots', money(filtered.reduce((s, r) => s + subtotal(r), 0)));
      updateBulkButtonsStateForTable('depot');
    }

    function updateBulkButtonsStateForTable(type) {
      let btn;
      if (type === 'achat') btn = el('#deleteSelectedAchats');
      else if (type === 'vente') btn = el('#deleteSelectedVentes');
      else if (type === 'depense') btn = el('#deleteSelectedDepenses');
      else if (type === 'dette') btn = el('#deleteSelectedDettes');
      else if (type === 'depot') btn = el('#deleteSelectedDepots');
      const bodyId = type === 'achat' ? 'achatBody' : type === 'vente' ? 'venteBody' : type === 'depense' ? 'depenseBody' : type === 'dette' ? 'detteBody' : 'depotBody';
      const anyChecked = els(`#${bodyId} .rowCheck`).some(c => c.checked);
      if (btn) btn.disabled = !anyChecked;
    }

    // Modal open/close
    function openModal(type, id = null) {
      formContext = type;
      editId = id;
      const titles = {
        achat: { title: 'Nouvel Achat', item: 'Article', party: 'Fournisseur' },
        vente: { title: 'Nouvelle Vente', item: 'Article', party: 'Client' },
        depense: { title: 'Nouvelle D√©pense', item: 'Description', party: 'B√©n√©ficiaire' },
        dette: { title: 'Nouvelle Dette', item: 'Description', party: 'Cr√©ancier' },
        depot: { title: 'Nouveau D√©p√¥t / Retrait', item: 'Type (D√©p√¥t/Retrait)', party: 'Op√©rateur / Compte' }
      };
      const t = titles[type] || titles['achat'];
      const mt = el('#modalTitle'); if (mt) mt.textContent = id ? `Modifier ${t.title}` : t.title;
      const fil = el('#f_item_label'); if (fil) fil.textContent = t.item;
      const fpl = el('#f_party_label'); if (fpl) fpl.textContent = t.party;
      el('#formError').classList.add('hidden');

      if (id) {
        const r = records.find(r => r.id === id && r.record_type === type);
        if (r) {
          el('#f_id').value = r.id;
          el('#f_date').value = r.date;
          el('#f_item').value = r.item;
          el('#f_qty').value = r.qty;
          el('#f_price').value = r.price;
          el('#f_party').value = r.party;
          el('#f_note').value = r.note || '';
          el('#f_method').value = r.method || 'autre';
        }
      } else {
        el('#entryForm').reset();
        el('#f_date').value = new Date().toISOString().split('T')[0];
        if (type === 'depot') {
          el('#f_item').value = 'D√©p√¥t';
          el('#f_qty').value = 1;
          el('#f_price').value = 0;
          el('#f_method').value = 'flooz';
        } else {
          el('#f_qty').value = 1;
          el('#f_price').value = 0;
          el('#f_method').value = 'autre';
        }
      }

      el('#modalOverlay').classList.remove('hidden');
    }

    function closeModal() {
      el('#modalOverlay').classList.add('hidden');
      el('#entryForm').reset();
      editId = null;
      el('#formError').classList.add('hidden');
    }

    function nextId() {
      const max = records.reduce((m, r) => Math.max(m, Number(r.id) || 0), 0);
      return (max || Date.now()) + 1;
    }

    function saveEntry(e) {
      e.preventDefault();
      const data = {
        record_type: formContext,
        date: el('#f_date').value,
        item: el('#f_item').value.trim(),
        qty: Number(el('#f_qty').value),
        price: Number(el('#f_price').value),
        party: el('#f_party').value.trim(),
        note: el('#f_note').value.trim(),
        method: el('#f_method') ? el('#f_method').value : undefined
      };

      if (!data.date || !data.item || !data.party || data.qty < 1 || data.price < 0 || Number.isNaN(data.qty) || Number.isNaN(data.price)) {
        el('#formError').classList.remove('hidden');
        return;
      }

      if (editId) {
        const idx = records.findIndex(r => r.id === Number(editId));
        if (idx !== -1) {
          records[idx] = { ...records[idx], ...data, id: Number(editId) };
        } else {
          records.push({ id: Number(editId), ...data });
        }
      } else {
        const id = nextId();
        records.push({ id, ...data });
      }

      saveToLocal();
      renderAll();
      closeModal();
    }

    function openConfirmModal(ids, type, isBulk = false) {
      el('#confirmText').textContent = isBulk
        ? `Voulez-vous vraiment supprimer ${ids.length} √©l√©ments s√©lectionn√©s ? Cette action est irr√©versible et affectera vos KPIs.`
        : 'Voulez-vous vraiment supprimer cet √©l√©ment ? Cette action est irr√©versible et affectera vos KPIs.';
      el('#confirmOverlay').classList.remove('hidden');
      el('#confirmOk').onclick = () => deleteEntries(ids, type);
    }

    function deleteEntries(ids, type) {
      records = records.filter(r => !ids.includes(Number(r.id)));
      saveToLocal();
      renderAll();
      el('#confirmOverlay').classList.add('hidden');
    }

    // ---------------------------
    // PDF export improvements
    // ---------------------------
    // Money formatter for PDF: avoids NBSP and ensures proper formatting
    function moneyForPdf(n) {
      const v = Number(n || 0);
      // format using French locale (gives NBSP), then replace NBSP with regular space
      const formatted = v.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\u202F|\u00A0/g, ' ');
      return formatted + ' FCFA';
    }

    function exportPDF(type) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');

      const filtered = records.filter(r => r.record_type === type);

      // Determine column config depending on type
      let columns = [];
      // We will use dataKey names to assign column styles below
      if (type === 'depot') {
        columns = [
          { header: 'Date', dataKey: 'date' },
          { header: 'Type', dataKey: 'item' },
          { header: 'Quantit√©', dataKey: 'qty' },
          { header: 'Montant (FCFA)', dataKey: 'price' },
          { header: 'M√©thode', dataKey: 'method' },
          { header: 'Op√©rateur/Compte', dataKey: 'party' },
          { header: 'Total (FCFA)', dataKey: 'total' },
          { header: 'Note', dataKey: 'note' }
        ];
      } else {
        const partyLabel = type === 'achat' ? 'Fournisseur' : type === 'vente' ? 'Client' : type === 'depense' ? 'B√©n√©ficiaire' : type === 'dette' ? 'Cr√©ancier' : 'Partie';
        columns = [
          { header: 'Date', dataKey: 'date' },
          { header: (type === 'depense' || type === 'dette') ? 'Description' : 'Article', dataKey: 'item' },
          { header: 'Quantit√©', dataKey: 'qty' },
          { header: 'Prix Unitaire (FCFA)', dataKey: 'price' },
          { header: partyLabel, dataKey: 'party' },
          { header: 'Total (FCFA)', dataKey: 'total' },
          { header: 'Note', dataKey: 'note' }
        ];
      }

      // Build rows and sanitize text (no NBSP)
      const rows = filtered.map(r => ({
        date: r.date || '',
        item: r.item || '',
        qty: String(r.qty || ''),
        price: moneyForPdf(r.price),
        method: r.method || '',
        party: r.party || '',
        total: moneyForPdf(subtotal(r)),
        note: r.note || ''
      }));

      const title = `Rapport ${type.charAt(0).toUpperCase() + type.slice(1)}s - ${new Date().toLocaleDateString('fr-FR')}`;
      doc.setFontSize(12);
      doc.text(title, 40, 40);

      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = { left: 40, right: 40, top: 60, bottom: 40 };
      const contentWidth = pageWidth - margin.left - margin.right;

      // Column width distribution (using dataKey names)
      // We intentionally make 'note' and 'total' wider as requested.
      const columnWidthsByKey = {};
      // sensible defaults scaled to contentWidth:
      // date small, qty small, price/total medium, item & party medium-larger, note large
      if (type === 'depot') {
        columnWidthsByKey['date'] = Math.round(contentWidth * 0.12);
        columnWidthsByKey['item'] = Math.round(contentWidth * 0.14);
        columnWidthsByKey['qty'] = Math.round(contentWidth * 0.07);
        columnWidthsByKey['price'] = Math.round(contentWidth * 0.12);
        columnWidthsByKey['method'] = Math.round(contentWidth * 0.10);
        columnWidthsByKey['party'] = Math.round(contentWidth * 0.15);
        columnWidthsByKey['total'] = Math.round(contentWidth * 0.14); // larger
        columnWidthsByKey['note'] = Math.round(contentWidth * 0.16);  // largest for notes
      } else {
        columnWidthsByKey['date'] = Math.round(contentWidth * 0.12);
        columnWidthsByKey['item'] = Math.round(contentWidth * 0.22);
        columnWidthsByKey['qty'] = Math.round(contentWidth * 0.06);
        columnWidthsByKey['price'] = Math.round(contentWidth * 0.12);
        columnWidthsByKey['party'] = Math.round(contentWidth * 0.14);
        columnWidthsByKey['total'] = Math.round(contentWidth * 0.14); // wider than default
        columnWidthsByKey['note'] = Math.round(contentWidth * 0.20);  // larger for notes
      }

      // Ensure total widths do not exceed contentWidth - if so, scale down proportionally
      const sumW = Object.values(columnWidthsByKey).reduce((a, b) => a + b, 0);
      if (sumW > contentWidth) {
        const scale = contentWidth / sumW;
        Object.keys(columnWidthsByKey).forEach(k => columnWidthsByKey[k] = Math.floor(columnWidthsByKey[k] * scale));
      }

      // Build columnStyles for autoTable keyed by dataKey
      const columnStyles = {};
      Object.keys(columnWidthsByKey).forEach(key => {
        columnStyles[key] = { cellWidth: columnWidthsByKey[key], valign: 'middle' };
        // right-align numeric columns
        if (key === 'price' || key === 'total' || key === 'qty') columnStyles[key].halign = 'right';
        // allow line breaks for note
        if (key === 'note') columnStyles[key].overflow = 'linebreak';
      });

      // Run autoTable
      doc.autoTable({
        startY: 60,
        head: [columns.map(c => c.header)],
        body: rows.map(r => columns.map(c => r[c.dataKey])),
        styles: { fontSize: 10, cellPadding: 6, overflow: 'linebreak', valign: 'middle' },
        headStyles: { fillColor: [26, 117, 255], textColor: 255, halign: 'center' },
        columnStyles: columnStyles,
        margin: margin,
        theme: 'grid',
        pageBreak: 'auto',
        didDrawPage: function (data) {
          const page = doc.internal.getNumberOfPages();
          doc.setFontSize(9);
          doc.text(`NBBC Gestion ‚Äî ${title}`, margin.left, 22);
          doc.setFontSize(9);
          doc.text(`Page ${page}`, pageWidth - margin.right - 50, 22);
        }
      });

      // compute total sum and display after the table (sanitized)
      const totalSum = filtered.reduce((s, r) => s + subtotal(r), 0);
      const sanitizedTotal = moneyForPdf(totalSum);

      // place summary after the table (if necessary move to next page)
      let yPos = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY + 16 : 80;
      if (yPos > (doc.internal.pageSize.getHeight() - margin.bottom - 40)) {
        doc.addPage();
        yPos = margin.top;
      }
      doc.setFontSize(11);
      doc.text(`Total ${type.charAt(0).toUpperCase() + type.slice(1)}s: ${sanitizedTotal}`, margin.left, yPos);

      // Save file
      const filename = `${type}s_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);
    }

    // ---------------------------
    // Chart rendering
    // ---------------------------
    function renderChart() {
      const svg = el('#monthlyChart');
      if (!svg) return;
      svg.innerHTML = '';
      const monthsSet = new Set(records.map(r => r.date ? r.date.slice(0, 7) : ''));
      const months = Array.from(monthsSet).filter(Boolean).sort();
      if (months.length === 0) return;

      const margin = { top: 20, right: 30, bottom: 40, left: 50 };
      const width = 800 - margin.left - margin.right;
      const height = 300 - margin.top - margin.bottom;

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('transform', `translate(${margin.left},${margin.top})`);
      svg.appendChild(g);

      const monthlyData = months.map(m => ({
        month: m,
        achats: records.filter(r => r.record_type === 'achat' && r.date.startsWith(m)).reduce((s, r) => s + subtotal(r), 0),
        ventes: records.filter(r => r.record_type === 'vente' && r.date.startsWith(m)).reduce((s, r) => s + subtotal(r), 0),
        depenses: records.filter(r => r.record_type === 'depense' && r.date.startsWith(m)).reduce((s, r) => s + subtotal(r), 0),
        dettes: records.filter(r => r.record_type === 'dette' && r.date.startsWith(m)).reduce((s, r) => s + subtotal(r), 0)
      }));

      const maxY = Math.max(...monthlyData.flatMap(d => [d.achats, d.ventes, d.depenses, d.dettes]), 1);
      const xScale = (i) => (i / (months.length - 1)) * width;
      const yScale = (v) => height - (v / maxY) * height;

      const colors = { achats: '#1a75ff', depenses: '#ef4444', ventes: '#ffd443', dettes: '#8b5cf6' };
      const series = ['achats', 'depenses', 'ventes', 'dettes'];

      series.forEach((label, seriesIndex) => {
        monthlyData.forEach((d, i) => {
          const barWidth = (width / months.length) / series.length - 2;
          const offset = seriesIndex * (barWidth + 2) - ((series.length - 1) * (barWidth + 2)) / 2;
          const x = xScale(i) + offset + (width / months.length) / 2;
          const val = d[label];
          const y = yScale(val);
          const barHeight = height - y;
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', x);
          rect.setAttribute('y', y);
          rect.setAttribute('width', barWidth);
          rect.setAttribute('height', barHeight);
          rect.setAttribute('fill', colors[label]);
          rect.setAttribute('class', 'bar');
          g.appendChild(rect);
        });
      });

      months.forEach((m, i) => {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', xScale(i));
        text.setAttribute('y', height + 30);
        text.setAttribute('class', 'chart-label');
        text.setAttribute('text-anchor', 'middle');
        text.textContent = m;
        g.appendChild(text);
      });

      const yTicks = [0, Math.round(maxY / 2), Math.round(maxY)];
      yTicks.forEach(v => {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', -10);
        text.setAttribute('y', yScale(v) + 5);
        text.setAttribute('class', 'chart-label');
        text.setAttribute('text-anchor', 'end');
        text.textContent = money(v);
        g.appendChild(text);
      });
    }

    function renderAll() {
      renderKPIs();
      renderChart();
      if (activeSection === 'achats') renderTableAchats();
      else if (activeSection === 'ventes') renderTableVentes();
      else if (activeSection === 'depenses') renderTableDepenses();
      else if (activeSection === 'dettes') renderTableDettes();
      else if (activeSection === 'depots') renderTableDepots();
    }

    // Sidebar open/close helpers
    function openSidebar() {
      el('#sidebar').classList.remove('-left-[320px]');
      el('#sidebar').classList.add('left-0', 'shadow-2xl');
    }
    function closeSidebar() {
      el('#sidebar').classList.add('-left-[320px]');
      el('#sidebar').classList.remove('left-0', 'shadow-2xl');
    }

    // Event wiring (safe)
    safeOn('#openSidebar', 'click', openSidebar);
    safeOn('#closeModal', 'click', closeModal);
    safeOn('#cancelForm', 'click', closeModal);
    safeOn('#entryForm', 'submit', saveEntry);
    safeOn('#confirmCancel', 'click', () => el('#confirmOverlay').classList.add('hidden'));

    els('.nav-link').forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveSection(btn.dataset.target);
        if (window.innerWidth <= 640) closeSidebar();
      });
    });

    safeOn('#quickAddAchat', 'click', () => openModal('achat'));
    safeOn('#quickAddVente', 'click', () => openModal('vente'));
    safeOn('#quickAddDepense', 'click', () => openModal('depense'));
    safeOn('#quickAddDette', 'click', () => openModal('dette'));
    safeOn('#quickAddDepot', 'click', () => openModal('depot'));

    safeOn('#addAchat', 'click', () => openModal('achat'));
    safeOn('#addVente', 'click', () => openModal('vente'));
    safeOn('#addDepense', 'click', () => openModal('depense'));
    safeOn('#addDette', 'click', () => openModal('dette'));
    safeOn('#addDepot', 'click', () => openModal('depot'));

    safeOn('#exportAchats', 'click', () => exportPDF('achat'));
    safeOn('#exportVentes', 'click', () => exportPDF('vente'));
    safeOn('#exportDepenses', 'click', () => exportPDF('depense'));
    safeOn('#exportDettes', 'click', () => exportPDF('dette'));
    safeOn('#exportDepots', 'click', () => exportPDF('depot'));

    el('#searchAchats')?.addEventListener('input', debounce(() => renderTableAchats(), 300));
    el('#searchVentes')?.addEventListener('input', debounce(() => renderTableVentes(), 300));
    el('#searchDepenses')?.addEventListener('input', debounce(() => renderTableDepenses(), 300));
    el('#searchDettes')?.addEventListener('input', debounce(() => renderTableDettes(), 300));
    el('#searchDepots')?.addEventListener('input', debounce(() => renderTableDepots(), 300));

    // select all handlers
    if (el('#selectAllAchats')) el('#selectAllAchats').addEventListener('change', (e) => { els('#achatBody .rowCheck').forEach(c => c.checked = e.target.checked); updateBulkButtonsStateForTable('achat'); });
    if (el('#selectAllVentes')) el('#selectAllVentes').addEventListener('change', (e) => { els('#venteBody .rowCheck').forEach(c => c.checked = e.target.checked); updateBulkButtonsStateForTable('vente'); });
    if (el('#selectAllDepenses')) el('#selectAllDepenses').addEventListener('change', (e) => { els('#depenseBody .rowCheck').forEach(c => c.checked = e.target.checked); updateBulkButtonsStateForTable('depense'); });
    if (el('#selectAllDettes')) el('#selectAllDettes').addEventListener('change', (e) => { els('#detteBody .rowCheck').forEach(c => c.checked = e.target.checked); updateBulkButtonsStateForTable('dette'); });
    if (el('#selectAllDepots')) el('#selectAllDepots').addEventListener('change', (e) => { els('#depotBody .rowCheck').forEach(c => c.checked = e.target.checked); updateBulkButtonsStateForTable('depot'); });

    if (el('#deleteSelectedAchats')) el('#deleteSelectedAchats').addEventListener('click', () => {
      const ids = els('#achatBody .rowCheck').filter(c => c.checked).map(c => Number(c.dataset.id));
      if (ids.length) openConfirmModal(ids, 'achat', true);
    });
    if (el('#deleteSelectedVentes')) el('#deleteSelectedVentes').addEventListener('click', () => {
      const ids = els('#venteBody .rowCheck').filter(c => c.checked).map(c => Number(c.dataset.id));
      if (ids.length) openConfirmModal(ids, 'vente', true);
    });
    if (el('#deleteSelectedDepenses')) el('#deleteSelectedDepenses').addEventListener('click', () => {
      const ids = els('#depenseBody .rowCheck').filter(c => c.checked).map(c => Number(c.dataset.id));
      if (ids.length) openConfirmModal(ids, 'depense', true);
    });
    if (el('#deleteSelectedDettes')) el('#deleteSelectedDettes').addEventListener('click', () => {
      const ids = els('#detteBody .rowCheck').filter(c => c.checked).map(c => Number(c.dataset.id));
      if (ids.length) openConfirmModal(ids, 'dette', true);
    });
    if (el('#deleteSelectedDepots')) el('#deleteSelectedDepots').addEventListener('click', () => {
      const ids = els('#depotBody .rowCheck').filter(c => c.checked).map(c => Number(c.dataset.id));
      if (ids.length) openConfirmModal(ids, 'depot', true);
    });

    document.addEventListener('click', (e) => {
      const editBtn = e.target.closest('.editOne');
      const delBtn = e.target.closest('.deleteOne');

      if (editBtn) {
        const id = Number(editBtn.dataset.id);
        const type = editBtn.dataset.type;
        openModal(type, id);
        return;
      }
      if (delBtn) {
        const id = Number(delBtn.dataset.id);
        const type = delBtn.dataset.type;
        openConfirmModal([id], type);
        return;
      }

      const th = e.target.closest('th[data-sort]');
      if (th) {
        const field = th.dataset.sort;
        const span = th.querySelector('span');
        const dir = span && span.textContent === '‚ñº' ? -1 : 1;
        sortTable(formContext, field, dir);
        if (span) span.textContent = dir === 1 ? '‚ñ≤' : '‚ñº';
      }
    });

    document.addEventListener('change', (e) => {
      if (e.target && e.target.matches('.rowCheck')) {
        const tbody = e.target.closest('tbody');
        if (!tbody) return;
        const id = tbody.id;
        const type = id === 'achatBody' ? 'achat' : id === 'venteBody' ? 'vente' : id === 'depenseBody' ? 'depense' : id === 'detteBody' ? 'dette' : 'depot';
        updateBulkButtonsStateForTable(type);
      }
    });

    function sortTable(type, field, dir) {
      const filteredRecords = records.filter(r => r.record_type === type);
      filteredRecords.sort((a, b) => {
        let va = a[field], vb = b[field];
        if (field === 'total') { va = subtotal(a); vb = subtotal(b); }
        if (typeof va === 'string') return dir * String(va).localeCompare(String(vb));
        return dir * (Number(va || 0) - Number(vb || 0));
      });
      records = records.filter(r => r.record_type !== type).concat(filteredRecords);
      saveToLocal();
      renderTable(type);
    }

    function setActiveSection(name) {
      activeSection = name;
      els('.section').forEach(s => s.classList.add('hidden'));
      const target = el(`#${name}Section`);
      if (target) target.classList.remove('hidden');
      el('#pageTitle').textContent = ({
        dashboard: 'Dashboard Central',
        achats: 'Gestion Achats',
        ventes: 'Gestion Ventes',
        depenses: 'Gestion D√©penses',
        dettes: 'Gestion Dettes',
        depots: 'Gestion d√©p√¥t/retrait (flooz/mux)'
      })[name] || 'Dashboard Central';

      els('.nav-link').forEach(b => b.classList.remove('nav-active', 'active'));
      const activeBtn = document.querySelector(`.nav-link[data-target="${name}"]`);
      if (activeBtn) activeBtn.classList.add('nav-active', 'active');

      renderAll();
      closeSidebar();
    }

    // Init
    loadFromLocal();
    renderAll();
    setActiveSection('dashboard');

    // Expose for debugging
    window._nbbc = { saveToLocal, loadFromLocal, records };

  </script>
</body>
</html>
